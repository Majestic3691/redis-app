#
# Redis Dockerfile
#
# https://github.com/dockerfile/redis
#

# Pull base image.
FROM redis


# Maintainer
LABEL maintainer="Michael Ryan <mtritconsulting@outlook.com>"

# Copy Content to the /data/redis directory.
COPY ./data/*.data ./redis/
COPY ./data/loaddata.sh ./redis/
COPY ./docker/redis.conf /etc

# Commands - load the data into redis.
RUN \
#  apt-get update && apt-get upgrade -y && \
  pwd && \
  cd /data/redis && \
  pwd && \
  ls -lta && \
  echo ">> Starting Redis to load data..." && \
  redis-server /etc/redis.conf  && \
  echo ">> /usr/local/bin/redis-cli ping" && \
  /usr/local/bin/redis-cli ping && \
  echo ">> Loading State Airports..." && \
  cat /data/redis/StateAirportsSetReady.data | /usr/local/bin/redis-cli --pipe  && \
  echo ">> Loading States..." && \
  cat /data/redis/StatesReady.data | /usr/local/bin/redis-cli --pipe && \
  echo ">> Loading Tasks..." && \
  cat /data/redis/TaskReady.data | /usr/local/bin/redis-cli --pipe && \
  echo ">> Loading GEO data..." && \
  cat /data/redis/GEOAirportDataReady.data | /usr/local/bin/redis-cli --pipe && \
  echo ">> Loading Call Log..." && \
  cat /data/redis/CallReady.data | /usr/local/bin/redis-cli --pipe && \
  echo ">> Verify GEO data..." && \
  /usr/local/bin/redis-cli geopos Texas Amoco && \
  echo ">> Verify Tasks data..." && \
  /usr/local/bin/redis-cli lrange tasks 0 -1 && \
  echo ">> Verify States..." && \
  /usr/local/bin/redis-cli smembers states && \
  echo ">> Verify State Airports (Massachusetts Cranland Crowhurst mi)..." && \
  /usr/local/bin/redis-cli geodist Massachusetts Cranland Crowhurst mi && \
  echo ">> Verify Call Log..." && \
  /usr/local/bin/redis-cli hgetall call && \
  echo ">> Shutdown Redis Server..." && \
  /usr/local/bin/redis-cli save

# Users

# Define mountable directories.
VOLUME ["/data"]

# Define working directory.
WORDDIR /data

# Define default command.
#CMD ["redis-server", "/etc/redis.conf"]

# Expose ports.
#EXPOSE 6379
